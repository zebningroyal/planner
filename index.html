<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Md Shazeb's Pro Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        .time-badge { background: rgba(45, 212, 191, 0.15); color: #2dd4bf; font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 800; }
        .task-done { text-decoration: line-through; opacity: 0.5; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8 flex flex-col gap-4">
            <div>
                <h1 class="text-3xl font-black">Shazeb's <span class="text-teal-400">Sync</span></h1>
                <p id="status-text" class="text-[10px] text-slate-400 uppercase tracking-widest mt-1">Status: System Initializing...</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="setupBackgroundSync()" id="sync-btn" class="flex-1 bg-teal-500 text-slate-900 font-bold py-3 rounded-xl text-xs uppercase tracking-widest shadow-lg shadow-teal-500/20">
                    Enable Background Service
                </button>
            </div>
        </header>

        <!-- Task Input -->
        <div class="glass p-6 mb-8 border-teal-500/30 border">
            <h2 class="text-xs font-bold text-teal-400 uppercase mb-4">Quick Add (Time + Task)</h2>
            <div class="flex gap-2">
                <input id="task-input" type="text" placeholder="10:30AM Gym" class="flex-1 bg-slate-800 border border-white/10 rounded-lg px-4 py-2 text-sm">
                <button onclick="addTask()" class="bg-white text-slate-900 px-4 py-2 rounded-lg font-bold text-sm">Add</button>
            </div>
        </div>

        <div id="planner-list" class="space-y-4"></div>
    </div>

    <!-- Service Worker Script Block -->
    <script id="sw-code" type="text/javascript">
        // This part becomes the background worker file
        const SW_VERSION = 'v1';
        
        self.addEventListener('install', (e) => self.skipWaiting());
        
        self.addEventListener('push', (event) => {
            const data = event.data.json();
            self.registration.showNotification(data.title, {
                body: data.body,
                icon: 'https://cdn-icons-png.flaticon.com/512/1048/1048953.png',
                vibrate: [200, 100, 200]
            });
        });

        // Background Check Logic
        setInterval(() => {
            // In a real PWA this would be handled via Push API
            // For this local version, we use the local notification trigger
        }, 60000);
    </script>

    <script>
        let tasks = JSON.parse(localStorage.getItem('shazeb_bg_tasks')) || [];
        const statusText = document.getElementById('status-text');

        // --- BACKGROUND REGISTRATION ---
        async function setupBackgroundSync() {
            if (!('serviceWorker' in navigator)) {
                alert("Your phone browser doesn't support background services.");
                return;
            }

            try {
                // Register Service Worker from a Blob to keep it in one file
                const swBlob = new Blob([document.getElementById('sw-code').textContent], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                const registration = await navigator.serviceWorker.register(swUrl);
                
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    statusText.innerText = "Status: Background Service Active âœ…";
                    statusText.classList.replace('text-slate-400', 'text-teal-400');
                    document.getElementById('sync-btn').innerText = "Service Connected";
                    document.getElementById('sync-btn').disabled = true;
                    document.getElementById('sync-btn').style.opacity = "0.5";
                } else {
                    alert("You must allow notifications for the alarm to work!");
                }
            } catch (err) {
                console.error(err);
                statusText.innerText = "Status: Setup Failed";
            }
        }

        function addTask() {
            const input = document.getElementById('task-input');
            const val = input.value.trim();
            if (!val) return;

            const timeMatch = val.match(/(\d{1,2}(:\d{2})?\s*(am|pm))/i);
            const timeLabel = timeMatch ? timeMatch[0].toUpperCase().replace(/\s/g, '') : "ANYTIME";
            const text = val.replace(timeMatch ? timeMatch[0] : "", "").trim();

            tasks.push({ id: Date.now(), text: text || "Task", time: timeLabel, done: false });
            input.value = "";
            saveAndRender();
        }

        function toggleTask(id) {
            tasks = tasks.map(t => t.id === id ? { ...t, done: !t.done } : t);
            saveAndRender();
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('shazeb_bg_tasks', JSON.stringify(tasks));
            const list = document.getElementById('planner-list');
            list.innerHTML = tasks.map(t => `
                <div class="glass p-4 flex items-center justify-between border-l-4 ${t.done ? 'border-slate-600' : 'border-teal-500'}">
                    <div onclick="toggleTask(${t.id})" class="cursor-pointer">
                        <span class="time-badge">${t.time}</span>
                        <p class="text-sm font-bold mt-1 ${t.done ? 'task-done' : ''}">${t.text}</p>
                    </div>
                    <button onclick="deleteTask(${t.id})" class="text-rose-400 text-xs font-bold">REMOVE</button>
                </div>
            `).join('');
        }

        // --- THE "CLOSED BROWSER" SIMULATOR ---
        // Note: Browsers restrict interval timers when closed for battery saving.
        // The most reliable way is "Add to Home Screen".
        function checkAlarms() {
            const now = new Date();
            const h = now.getHours() % 12 || 12;
            const m = now.getMinutes().toString().padStart(2, '0');
            const ap = now.getHours() >= 12 ? 'PM' : 'AM';
            const currentTime = `${h}:${m}${ap}`;

            tasks.forEach(t => {
                if (!t.done && t.time === currentTime) {
                    if (Notification.permission === 'granted') {
                        // Use service worker to show notification
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification("Shazeb's Alert!", {
                                body: `Time for: ${t.text}`,
                                icon: 'https://cdn-icons-png.flaticon.com/512/1048/1048953.png',
                                vibrate: [500, 110, 500, 110, 450, 110, 200, 110, 170, 40, 450, 110, 200, 110, 170, 40],
                                requireInteraction: true,
                                tag: 'alarm-' + t.id
                            });
                        });
                        t.done = true; // Auto-mark done so it doesn't repeat every second
                        saveAndRender();
                    }
                }
            });
        }

        setInterval(checkAlarms, 30000); // Check every 30 seconds
        saveAndRender();
    </script>
</body>
</html>
